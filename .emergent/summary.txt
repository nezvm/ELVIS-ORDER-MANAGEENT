<analysis>**original_problem_statement:**
The user wants to extend their Django-based ERP system, Elvis-Manager.

**Initial & Revised Requirements:**
*   **UI/UX Overhaul:** A complete replacement of the legacy UI with a modern, responsive layout (sidebar + top bar), consistent design system, and improved components. All pages must use a single, unified theme.
*   **New 'Marketing' Module:**
    *   **Leads Management:** Sync Google contacts into a new  model. Automatically classify leads as 'WIN' (matches existing customer/order) or 'LOSS'. Sync improved lead names back to Google.
    *   **Shopify Abandoned Cart Recovery:** Sync abandoned checkouts from Shopify into the  model. This includes capturing cart details, recovery URLs, and customer info. Implement merge logic to avoid duplicate leads and track when an abandoned cart is successfully converted into an order.
    *   **WhatsApp Broadcasting:** Create a plug-and-play system for WhatsApp providers (specifically Meta Cloud API). Implement event-driven notifications and a campaign broadcasting system. A key campaign type is Abandoned Recovery which sends automated follow-ups to leads from Shopify.
    *   **Market Insights:** Build dashboards showing geo-intelligence data (by State -> District -> Pincode) for both orders and leads. This includes metrics like lead counts, conversion rates, revenue, and RTO share. The dashboard must differentiate between accurate data from orders and enriched data from leads, and track metrics related to abandoned carts.

**User's preferred language**: English

**what currently exists?**
The project is set up with Django, PostgreSQL, and Redis. The agent has successfully implemented two major feature sets:
1.  **Initial Marketing Module:** Created the  Django app with a new UI based on the user's specified color scheme (Black, White, #AE1F25). This included pages for Leads, WhatsApp, Campaigns, and Market Insights, all inheriting from a new base template ().
2.  **Shopify Abandoned Cart Feature:** Extended the  and  models to support abandoned cart data. Implemented mock services to handle the sync logic, lead merging, and conversion tracking. The Market Insights dashboard was updated with new tabs and KPIs for abandoned cart analysis.

Both of these milestones were successfully tested using the testing agent. The agent is now in the middle of a third major task: unifying the UI theme across the entire application.

**Last working item**:
- **Last item agent was working:** UI Theme Unification. The agent was systematically migrating all legacy templates to inherit from the new, unified base template (). Templates for the Dashboard, Orders, Customers, Products, and Logistics modules have been overwritten. The agent was about to create new templates for the , , and  modules.
- **Status:** IN PROGRESS
- **Agent Testing Done:** N
- **Which testing method agent to use?** Frontend testing agent. This is crucial to visually verify that all pages across the application have been successfully and consistently migrated to the new theme.
- **User Testing Done:** N

**All Pending/In progress Issue list**:
- **Issue 1: UI Theme is inconsistent across the application (Priority: P0)**
    - **Description:** Many pages still extend old base templates (, ), creating a jarring and inconsistent user experience. The user has mandated that 100% of the application must use the new, unified theme defined in .
    - **Attempted fixes:** The agent has audited all templates and has already migrated several key modules (Core, Order, Master, Logistics) by overwriting their templates to extend .
    - **Next debug checklist:**
        1.  Create/overwrite templates for the remaining modules: , , , , and , ensuring they all extend .
        2.  Update the corresponding  files to render these new templates if necessary.
        3.  Perform a global search-and-replace to change any remaining instances of  or  to .
        4.  Delete the old, now-unused base templates and partials (e.g., , ) to prevent future use.
        5.  Once migration is complete, run the frontend testing agent to spot-check all major pages for visual consistency.
    - **Why fix this issue and what will be achieved with the fix?** This is a mandatory requirement to provide a professional, modern, and cohesive user experience, which is a primary acceptance criterion for the user.
    - **Status:** IN PROGRESS
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** Frontend
    - **Blocked on other issue:** None. This is the highest priority task.

**In progress Task List**:
- **Task 1: Complete the UI Theme Unification (Priority: P0)**
    - **Where to resume:** The agent has just finished creating templates for the Logistics module. The immediate next step is to create the new, unified templates for the , , and  modules.
    - **What will be achieved with this?** A single, consistent, modern theme will be applied across the entire ERP, fulfilling a critical user requirement and eliminating the broken, mixed-theme experience.
    - **Status:** IN PROGRESS
    - **Should Test frontend/backend/both after fix?** Frontend

**Upcoming and Future Tasks**
- **Upcoming Tasks (P0):**
    - **Implement Live Google Contacts Sync:** Replace the mock service with a real implementation using the Google People API and OAuth for authentication.
    - **Implement Live Shopify Abandoned Checkout Sync:** Replace the mock service with a real cron job or webhook-based integration to fetch data from the Shopify Admin API.
    - **Implement Live WhatsApp Integration:** Build the real integration with the Meta Cloud API to send Abandoned Recovery messages.
- **Future Tasks (P1):**
    - **Refine Shopify Integration:** Implement the logic to split Shopify orders into  and  dynamic channels.
    - **Enhance Logistics UI:** Polish the logistics panel to a ClickPost-level experience with more advanced features like bulk actions and drawers.

**Completed work in this session**
- **Marketing Module & UI Foundation:** Built and tested the core marketing pages (Leads, WhatsApp, Campaigns, Insights) with the new UI theme.
- **Abandoned Cart Recovery Feature:** Implemented the complete (mocked) backend logic and frontend UI for tracking Shopify abandoned carts, including model extensions, services for sync/conversion, and new dashboards. This work was validated by the testing agent.
- **UI Unification Progress:** Audited all application templates and began the migration process, successfully updating the templates for the Dashboard, Orders, Customers, Products, and Logistics modules.

**Earlier issues found/mentioned but not fixed**
- None. The primary issue was the inconsistent UI, which is currently being fixed.

**Known issue recurrence from previous fork**
- N/A

**Code Architecture**


**Key Technical Concepts**
-   **Backend:** Django, Django REST Framework
-   **Database:** PostgreSQL
-   **Async Tasks:** Celery with a Redis broker
-   **Frontend:** Django Template Language (DTL), Tailwind CSS (via CDN in )

**key DB schema**
-   ****: Extended with , , , , , , , , , and  ('WIN', 'LOSS', 'CONVERTED').
-   ****: Extended with  ('Standard', 'Abandoned Recovery').
-   ****: Extended with .
-   ****: New model for geo-location enrichment.
-   ****, ****, ****: New models for analytics.

**changes in tech stack**
- The project has standardized on PostgreSQL.

**All files of reference**
-   **/app/templates/ui/base.html**: The single source of truth for the application's layout and design.
-   **/app/marketing/models.py**: Contains the extended schema for Leads, Campaigns, and new analytics models.
-   **/app/marketing/services.py**: Contains the (currently mock) business logic for syncing Shopify data and lead management.
-   **/app/marketing/views.py**: Contains the view logic for the new tabbed Market Insights dashboard.
-   All template files within  are relevant to the ongoing UI unification task.

**Areas that need refactoring**:
- After the UI migration is complete, all legacy template directories (, ) and files (, etc.) must be deleted to eliminate technical debt.
- Legacy CSS and JS assets associated with the old themes should be removed from the static files and their references removed from the project.

**key api endpoints**
-   No new API endpoints were created in this session, but existing views and services were heavily modified. The core API endpoints remain under .

**Critical Info for New Agent**
-   **Complete UI Unification First:** Your immediate priority is to finish the UI migration task. Do not start any new feature work until every single page extends  and the application has a consistent look and feel.
-   **Integrations are Mocked:** The core logic for Google Contacts, Shopify Abandoned Checkouts, and the WhatsApp Meta Cloud API is currently placeholder code. These are the next major implementation tasks once the UI is stable.
-   **Adhere to User Specifications:** The user's detailed requirements in messages #115 and #190 are the source of truth for the marketing and UI features. Refer to them for all implementation details.

**documents and test reports created in this job**
-   /app/memory/PRD.md
-   /app/test_reports/iteration_1.json
-   /app/test_reports/iteration_2.json

**Last 10 User Messages and any pending HUMAN messages**
-   **User Message #190:** Provided detailed mandatory requirements for a complete UI/UX theme unification. Stated that all pages must use a single modern theme and all old base templates and assets must be removed. This initiated the current 
wtmp begins Mon Jan 12 11:39:31 2026.
-   **User Message #115:** Provided a very comprehensive list of new features and updates, primarily focused on implementing a Shopify Abandoned Cart recovery pipeline, enhancing the Market Insights dashboard with new tabs and metrics, and defining lead merge/conversion rules. This work has been completed (with mock integrations).

**Project Health Check:**
-   **Broken:** The UI is in a broken, transitional state due to the ongoing theme unification. Some pages render the new modern theme while others render a legacy one. This is the top priority to fix.
-   **Mocked:** The backend logic for all key third-party integrations (Google, Shopify, WhatsApp) is currently placeholder code in the  files. The features are not functional in a live environment.

**3rd Party Integrations**
-   **Google Workspace (People API):** Planned, but implementation is currently mocked.
-   **Shopify (Admin API):** Partially implemented. Order sync exists, but the new Abandoned Checkout sync is mocked.
-   **WhatsApp (Meta Cloud API):** Planned, but implementation is currently mocked.

**Testing status**
-   **Testing agent used after significant changes:** YES. The agent was used successfully after the initial marketing module implementation and after the abandoned cart feature implementation.
-   **Test files created:** None.
-   **Known regressions:** None.

**Credentials to test flow:**
-   **ERP Superuser Login:**
    -   Username: 
    -   Password: 

**What agent forgot to execute**
- The agent has been following user instructions sequentially. The implementation of live third-party integrations was intentionally deferred in favor of building out the UI and business logic with placeholders, as per the user's focus. Nothing has been forgotten.</analysis>
