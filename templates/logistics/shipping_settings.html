{% extends 'ui/base.html' %}
{% load static humanize %}

{% block title %}Shipping Settings{% endblock %}
{% block page_title %}Shipping Settings{% endblock %}

{% block content %}
<div class="max-w-4xl space-y-6">
    <form method="POST">
        {% csrf_token %}
        
        <!-- Primary Carrier -->
        <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm mb-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Primary Carrier</h3>
            <p class="text-sm text-gray-500 mb-4">The primary carrier is used as the default when no other rules match.</p>
            <select name="primary_carrier" class="w-full max-w-md px-4 py-3 border border-gray-200 rounded-xl bg-white">
                <option value="">No Primary Carrier</option>
                {% for c in carriers %}
                <option value="{{ c.id }}" {% if settings.primary_carrier == c %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Allocation Settings -->
        <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm mb-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Allocation Settings</h3>
            
            <div class="space-y-4">
                <label class="flex items-center">
                    <input type="checkbox" name="enable_channel_rules" {% if settings.enable_channel_rules %}checked{% endif %} class="rounded mr-3">
                    <span class="text-gray-700">Enable channel-based carrier selection</span>
                </label>
                
                <label class="flex items-center">
                    <input type="checkbox" name="enable_pincode_rules" {% if settings.enable_pincode_rules %}checked{% endif %} class="rounded mr-3">
                    <span class="text-gray-700">Enable pincode-based carrier selection (highest priority)</span>
                </label>
                
                <label class="flex items-center">
                    <input type="checkbox" name="enable_auto_allocation" {% if settings.enable_auto_allocation %}checked{% endif %} class="rounded mr-3">
                    <span class="text-gray-700">Automatically allocate carriers to new orders</span>
                </label>
                
                <label class="flex items-center">
                    <input type="checkbox" name="check_serviceability" {% if settings.check_serviceability_before_allocation %}checked{% endif %} class="rounded mr-3">
                    <span class="text-gray-700">Check carrier serviceability before allocation</span>
                </label>
            </div>
        </div>
        
        <!-- Default Values -->
        <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm mb-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Default Values</h3>
            
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Default Package Weight (kg)</label>
                    <input type="number" step="0.1" name="default_weight" value="{{ settings.default_weight_kg }}" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Maximum COD Amount (â‚¹)</label>
                    <input type="number" name="max_cod_amount" value="{{ settings.max_cod_amount|floatformat:0 }}" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                </div>
            </div>
        </div>
        
        <!-- Save Button -->
        <div class="flex justify-end">
            <button type="submit" class="px-6 py-3 bg-black text-white rounded-xl font-semibold hover:bg-gray-800">
                <i class="fas fa-save mr-2"></i>Save Settings
            </button>
        </div>
    </form>
    
    <!-- Test Carrier Connections -->
    <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Test Carrier Connections</h3>
        <p class="text-sm text-gray-500 mb-4">Test API connectivity for each carrier.</p>
        
        <div class="space-y-3">
            {% for c in carriers %}
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                <div class="flex items-center">
                    <span class="font-medium text-gray-900">{{ c.name }}</span>
                    <span class="ml-2 px-2 py-0.5 rounded text-xs {% if c.status == 'active' %}bg-green-100 text-green-700{% else %}bg-gray-100 text-gray-700{% endif %}">{{ c.status }}</span>
                </div>
                <div class="flex items-center gap-4">
                    <span id="test-result-{{ c.id }}" class="text-sm"></span>
                    <button type="button" onclick="testCarrier('{{ c.id }}')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200">
                        <i class="fas fa-plug mr-1"></i>Test
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function testCarrier(carrierId) {
    const resultEl = document.getElementById(`test-result-${carrierId}`);
    resultEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    
    try {
        const response = await fetch(`/logistics/carriers/${carrierId}/test/`, {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken}
        });
        const data = await response.json();
        
        if (data.success) {
            resultEl.innerHTML = '<span class="text-green-600"><i class="fas fa-check mr-1"></i>Connected</span>';
        } else {
            resultEl.innerHTML = `<span class="text-red-600"><i class="fas fa-times mr-1"></i>${data.message}</span>`;
        }
    } catch (e) {
        resultEl.innerHTML = '<span class="text-red-600"><i class="fas fa-times mr-1"></i>Error</span>';
    }
}
</script>
{% endblock %}
